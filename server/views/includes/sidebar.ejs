<div id="account_info">
    <div id="userDisplay" style="display: none;"></div>
    <a id="logoutButton" href="#" id="logoutButton" style="display: none;">[logout]</a>
</div>


<div id="sidebar_container">

    <% if (category && category.name) { %>
        <div class="category-metadata-box">
            <h2>
                <%= category.name %>
            </h2>
            <p id="cat_permalink"><a href="/c/<%= category.permalink %>">/c/<%= category.permalink %></a></p>
            <% if (category.creator) { %>
                <p id="cat_createdby">Created by <%= category.creator %>
                        <% } %>

                         
                </p>
                <button id="subscribe_button">Subscribe</button>
                <% if (category.description) { %>
                    <p><%- category.description %></p>
                    <% } %>
                        <% if (category.moderators) { %>
                            <p>Moderators: <%= category.moderators %>
                            </p>
                            <% } else { %>
                                <p>No moderators</p>
                                <% } %>
        </div>
        <% } %>


            <div class="sidebar">

                <button id="loginRegisterButton" class="sidebar_button">Login/Register</button>




                <a href="/submit-post" style="margin-bottom: 20px; display: block;"><button class="sidebar_button"
                        type="button">Create a post</button></a>

                <a href="/submit-category"><button class="sidebar_button" type="button">Create a category</button></a>


            </div>

            <div id="explore_sidebar">

                <div id="rights"><i class="fas fa-scroll"></i><span id="rights_span"><a href="#">Our
                            Commitment</a></span>
                </div>
                <div id="rules"><i class="fas fa-gavel"></i><span id="rules_span"><a href="#">The Rules</a></span>
                </div>

                <div id="subscribed_spaces_container" style="display: none;">
                    <h3 id="subscribed_heading">Subscribed</h3>
                    <ul id="subscribed_links"></ul>
                </div>

                <h3 id="explore_heading">Explore</h3>
                <ul class="community-links">


                </ul>
                <a href="#" class="show-more" id="showMoreBtn">Show more ...</a>

            </div>




</div>


<script>

    $(document).ready(function () {

        function fetchAndDisplayCategories() {
            $.ajax({
                url: '/api/categories',
                type: 'GET',
                success: function (categories) {
                    console.log(categories);
                    const $communityLinks = $('.community-links');
                    $communityLinks.empty(); // Clear existing categories
                    categories.forEach(function (category) {
                        // Assuming 'name' and 'permalink' are properties of the category
                        const categoryLink = `<li><a href="/c/${category.permalink}">/c/${category.permalink}</a></li>`;
                        $communityLinks.append(categoryLink);
                    });
                },
                error: function (error) {
                    console.error('Failed to fetch categories:', error);
                }
            });
        }

        fetchAndDisplayCategories();

        function checkSubscriptionStatus() {

            if ($('#cat_permalink a').length < 1)
                return;

            const permalink = $('#cat_permalink a').attr('href').split('/c/')[1];
            let subscriptions = JSON.parse(localStorage.getItem('userSubscriptions')) || [];

            if (subscriptions.includes(permalink)) {
                // User is subscribed to this category
                $('#subscribe_button').text('Unsubscribe').addClass('unsubscribe');
            } else {
                // User is not subscribed to this category
                $('#subscribe_button').text('Subscribe').removeClass('unsubscribe');
            }

            // Show the button after setting the correct status
            $('#subscribe_button').css('visibility', 'initial');
        }

        checkSubscriptionStatus(); // Check and set subscription status on page load


        $('#subscribe_button').click(function () {
            const permalink = $('#cat_permalink a').attr('href').split('/c/')[1];
            const authToken = localStorage.getItem('authToken');

            // Determine the action based on the button's class
            const isSubscribed = $(this).hasClass('unsubscribe');
            const url = isSubscribed ? '/api/unsubscribe' : '/api/subscribe'; // Toggle between subscribe and unsubscribe URLs
            const actionText = isSubscribed ? 'Subscribe' : 'Unsubscribe'; // The action to perform

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                },
                data: JSON.stringify({ permalink: permalink }),
                success: function (response) {
                    console.log(response.message);
                    updateLocalSubscriptions(permalink, !isSubscribed);
                    // Toggle the button text and class based on the current state
                    if (isSubscribed) {
                        $('#subscribe_button').text('Subscribe');
                        $('#subscribe_button').removeClass('unsubscribe');
                    } else {
                        $('#subscribe_button').text('Unsubscribe');
                        $('#subscribe_button').addClass('unsubscribe');
                    }
                    refreshSubscriptions();

                },
                error: function (xhr, status, error) {
                    console.error('Action failed:', xhr.responseText);
                    // Handle errors
                }
            });
        });

        // Example of updating local storage after subscribing/unsubscribing
        function updateLocalSubscriptions(permalink, isSubscribing) {
            console.log(permalink, isSubscribing);
            let subscriptions = JSON.parse(localStorage.getItem('userSubscriptions')) || [];

            if (isSubscribing) {
                // Add to local storage array if not already present
                if (!subscriptions.includes(permalink)) {
                    subscriptions.push(permalink);
                }
            } else {
                // Remove from local storage array
                subscriptions = subscriptions.filter(sub => sub !== permalink);
            }

            localStorage.setItem('userSubscriptions', JSON.stringify(subscriptions));
        }



        function refreshSubscriptions() {
            // Fetch the subscriptions from local storage
            let subscriptions = JSON.parse(localStorage.getItem('userSubscriptions')) || [];

            // Check if there are any subscriptions
            if (subscriptions.length > 0) {
                // Make sure the container is visible
                $('#subscribed_spaces_container').show();

                // Empty the current list to avoid duplicates
                $('#subscribed_links').empty();

                // Loop through the subscriptions and append each to the list
                subscriptions.forEach(function (sub) {
                    console.log(sub); 
                    $('#subscribed_links').append(`<li><a href="/c/${sub}">/c/${sub}</a></li>`);
                });
            } else {
                // Hide the container if there are no subscriptions
                $('#subscribed_spaces_container').hide();
            }
        }

        refreshSubscriptions();






    });

</script>